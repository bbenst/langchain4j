# langchain4j-core 复杂关键接口

本文聚焦 `langchain4j-core` 中“接口职责覆盖面大、默认方法流程复杂、对实现者约束强”的关键接口，并总结其职责与关键实现细节，便于快速理解与实现。

## StreamingChatModel
**职责说明**：定义支持流式输出的对话模型接口，提供统一的流式调用入口。实现者通常只需实现 `doChat`，上层逻辑由默认方法负责调度。

**关键实现细节**：
- 默认 `chat` 方法构造 `finalChatRequest`，合并请求参数（`defaultRequestParameters().overrideWith(...)`）。
- 创建 `StreamingChatResponseHandler` 代理，包装用户 handler，并在完成/异常时触发监听器回调（`ChatModelListenerUtils`）。
- `onCompleteResponse` 中会先触发监听器，再转发给外部 handler；`onError` 同理。该流程保证可观测性与业务处理解耦。

相关文件：`langchain4j-core/src/main/java/dev/langchain4j/model/chat/StreamingChatModel.java`

## ChatModel
**职责说明**：定义同步对话模型的核心入口，封装了参数合并、监听器触发与异常处理逻辑。

**关键实现细节**：
- 默认 `chat(ChatRequest)` 负责构建 `finalChatRequest` 并触发 `onRequest`/`onResponse`/`onError`。
- 将真正模型调用下沉到 `doChat`，强制实现者仅关注模型调用细节。
- 提供多种重载入口（`chat(String)`、`chat(List<ChatMessage>)` 等）以标准化调用姿势。

相关文件：`langchain4j-core/src/main/java/dev/langchain4j/model/chat/ChatModel.java`

## EmbeddingStore
**职责说明**：定义向量存储的统一抽象，覆盖增删查与批量操作，是 RAG 检索链路的核心组件之一。

**关键实现细节**：
- 方法覆盖面广：单条/批量添加、带元数据的内容关联、过滤删除、向量检索等。
- 多处默认实现提供降级行为（如未实现 `removeAll` 会抛 `UnsupportedFeatureException`），要求实现者明确能力边界。
- `addListener(s)` 通过包装 `ListeningEmbeddingStore` 注入可观测能力，保持非侵入式扩展。

相关文件：`langchain4j-core/src/main/java/dev/langchain4j/store/embedding/EmbeddingStore.java`

## ContentRetriever
**职责说明**：定义 RAG 检索阶段的内容获取接口，面向多种数据源（向量库、全文检索、混合检索等）。

**关键实现细节**：
- 仅暴露 `retrieve(Query)`，但默认方法负责监听器包装与集合类型适配。
- `addListeners` 会复用已有 `ListeningContentRetriever` 或创建新包装，以保证监听器顺序一致。

相关文件：`langchain4j-core/src/main/java/dev/langchain4j/rag/content/retriever/ContentRetriever.java`

## RetrievalAugmentor
**职责说明**：RAG 入口接口，负责把检索到的内容注入到对话消息中，构建最终增强后的请求。

**关键实现细节**：
- 只定义核心 `augment` 方法，但其语义覆盖“检索→聚合→注入”的完整流程。
- 建议实现者参考 `DefaultRetrievalAugmentor`，确保与现有 RAG 组件兼容。

相关文件：`langchain4j-core/src/main/java/dev/langchain4j/rag/RetrievalAugmentor.java`
